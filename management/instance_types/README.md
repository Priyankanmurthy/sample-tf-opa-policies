# Scalr Policy Library

## Policy :: instance_types

Enforces a whitelist of allowed instance types/sizes for AWS, Azure and Google.

### Files

| Files | Description |
|---|---|
| instances_types.rego | The OPA policy |
| instance_types.tf | Terraform config used to generate mock data for policy evaluation |
| instance_types.input.json | Mock data (tfplan, tfrun) generated by Scalr |
| eval.output | Expected output from running `POL=instance_types opa eval -f pretty --data ${POL}.rego -i ${POL}.input.json data.terraform.deny` |

### How to use this policy

#### Cloning and testing

---

NOTE: See [Terraform CLI with Scalr](https://docs.scalr.com/en/latest/cli.html) for details on creating an API token to enable the CLI to work with Scalr

---

The Terraform config in this repo is an example that requires AWS, Azure and Google credentials.

1. Clone this repository
2. Edit instances_types.rego as required, e.g. to adjust whitelists
3. Replace instances_types.tf with your own Terraform configuration that you need to test the policy against. Ensure the config contains a [partial backend configuration](https://www.terraform.io/docs/language/settings/backends/configuration.html#partial-configuration) similar to this with a workspace name of your choice.

```javascript
terraform {

  backend "remote" {
    workspaces {
      name = "{ws-name}"
    }
  }
}
```

4. Set your remote backed hostname and organization (Scalr environment) parameters using `TF_CLI_ARGS_init` as follows.

`export TF_CLI_ARGS_init='-backend-config="hostname={your-scalr-hostname}" -backend-config="organization={your-scalr-evironment_id}"'`.

  When using Scalr SaaS the hostname will be in the form `my-account.scalr.io`.
  The environment_id will be in the form `env-{random_string}` and can be obtained from the environment dashboard.

5. Run `terraform init` to initialize the workspace.
6. Run `./generate_plan.sh` to generate a plan and download the mock data.
7. Evaluate the policy using `opa eval -f pretty --data instance_types.rego -i input.json data.terraform.deny`

#### Adding to a Policy Group

You can now create a policy group for this policy or add it to an existing policy group. See [Policy Groups](https://docs.scalr.com/en/latest/opa.html#creating-policy-groups) for a detailed explanation. In summary do the following.

1. Copy the policy file (`instance_types.rego`) to the VCS repo for the policy group.
2. Add and entry to `scalr-policy.hcl` file to enable the policy and set the enforcement level. e.g.

```javascript
version = "v1"

policy "instance_types" {
    enabled = true
    enforcement_level = "hard-mandatory"
}
```

3. If you are creating a new policy group you can now set that up in the Scalr UI. If it is an existing policy group it will automatically re-sync when you commit the new policy file and updated `scalr-policy.hcl` to the repo.
